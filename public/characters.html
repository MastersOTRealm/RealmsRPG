<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Characters - Realms: The Freeform Roleplaying Game</title>
    <link rel="stylesheet" href="/styles/main.css">
</head>
<body>
<header id="header"></header>
<main>
    <section id="characters-section">
        <h2>Characters</h2>
        <div class="character-grid" id="character-grid">
            <!-- dynamically populated -->
        </div>
    </section>
</main>
<footer id="footer"></footer>
<script type="module">
  import { initializeFirebase, handleAuthStateChange } from './scripts/auth.js';

  async function loadHeaderFooter() {
    const header = document.getElementById('header');
    const footer = document.getElementById('footer');
    if (header) header.innerHTML = await fetch('/header.html').then(r => r.text());
    if (footer) footer.innerHTML = await fetch('/footer.html').then(r => r.text());
  }
  loadHeaderFooter();

  document.addEventListener('DOMContentLoaded', async () => {
    const { auth, db } = await initializeFirebase();
    handleAuthStateChange(auth, db);

    const grid = document.getElementById('character-grid');

    function addPlaceholderCharacter() {
      const placeholderCard = document.createElement('a');
      placeholderCard.href = '/characterSheet.html?id=placeholder';
      placeholderCard.className = 'character-card sample';
      placeholderCard.innerHTML = `
        <div class="portrait">
          <img src="https://via.placeholder.com/180x180/8b7355/ffffff?text=Gath" alt="Gath the Destroyer">
        </div>
        <p class="name">GATH (SAMPLE)</p>
      `;
      grid.appendChild(placeholderCard);
    }

    function addCharacterSlot() {
      const addSlot = document.createElement('div');
      addSlot.className = 'character-card add-new';
      addSlot.innerHTML = `
        <div class="portrait placeholder"><span class="plus">+</span></div>
        <p class="name add-text">Add Character</p>
      `;
      addSlot.addEventListener('click', () => {
        window.location.href = '/characterCreator.html';
      });
      grid.appendChild(addSlot);
    }

    async function loadCharacters() {
      grid.innerHTML = '';
      
      // Always add placeholder character first for testing
      addPlaceholderCharacter();
      
      if (!auth.currentUser) {
        addCharacterSlot();
        return;
      }
      // Fetch saved characters (collection 'character')
      const snap = await db.collection('users').doc(auth.currentUser.uid).collection('character').get();
      if (snap.empty) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.padding = '16px';
        emptyMsg.style.opacity = '.75';
        emptyMsg.textContent = 'You have no saved characters yet.';
        grid.appendChild(emptyMsg);
        addCharacterSlot();
        return;
      }
      snap.forEach(doc => {
        const data = doc.data();
        const card = document.createElement('div');
        card.className = 'character-card';
        card.innerHTML = `
          <div class="portrait">
            <img src="${data.portrait || '/images/default-avatar.png'}" alt="${data.name || 'Character'}">
          </div>
          <p class="name">${(data.name || 'Unnamed').toUpperCase()}</p>
        `;
        card.addEventListener('click', () => {
          window.location.href = `/characterSheet.html?id=${doc.id}`;
        });
        grid.appendChild(card);
      });
      addCharacterSlot();
    }

    // Wait a short delay if auth might not be ready
    if (!auth.currentUser) {
      setTimeout(loadCharacters, 400);
    } else {
      loadCharacters();
    }
  });
</script>
</body>
</html>
